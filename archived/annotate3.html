<!doctype html>
<html lang="en">
  <head>
  	<title>Squirrel Detector</title>
    <link rel="icon" href="static/images/favicon.png" type="image/x-icon"/>
    <link rel="shortcut icon" href="static/images/favicon.png" type="image/x-icon"/>    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.1/mdb.min.css" rel="stylesheet" />       
    <script src="/static/js/fabric.min.js"></script>
  </head>
  <body>
		
		<div class="d-flex align-items-stretch">
            <nav id="sidebar">
				<div class="p-4 pt-5">
		  		<a href="index.html" class="img logo mb-5" ><img src="/static/images/sq.png" style="width:150px;height:150px"></a>
	        <ul class="list-unstyled components mb-5">

	          <li>
	              <a href="index.html">Home</a>
	          </li>
	          <li>
              <a href="collect.html">1. Collect</a>
	          </li>
	          <li class="active">
              <a href="annotate.html">2. Annotate</a>
	          </li>
	          <li>
              <a href="train.html" class="text-secondary">3. Train</a>
	          </li>
	          <li>
              <a href="detect.html" class="text-secondary">4. Detect</a>
	          </li>            
	          <li>
              <a href="manage.html" >Manage</a>
	          </li>                
	        </ul>

	        <div class="footer fixed-bottom ml-3">
	        	<p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
						  Copyright &copy; 2023 All rights reserved <br> Template provided by <a href="https://colorlib.com" target="_blank">Colorlib.com</a>
	        </div>

	      </div>
    	</nav>

        <!-- Page Content  -->
      <div id="content" class="p-4 p-md-5">


            <!-- Navbar-->
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
              <div class="container-fluid justify-content-between">
                <!-- Left elements -->
                <div class="d-flex">
                  - 

                </div>
                <!-- Left elements -->

                <!-- Center elements -->
                <ul class="navbar-nav flex-row d-none d-md-flex">

                  <li id="imagecounter" class="nav-item me-3 me-lg-1 text-center"> </li>

                </ul>
                <!-- Center elements -->

                <!-- Right elements -->
                <ul class="navbar-nav flex-row">

                  <li class="nav-item me-3 me-lg-1">
                    <a class="nav-link disabled" href="#" id="btn-prev">
                      <span><i class="fas fa-circle-chevron-left fa-lg "></i></span>
                    </a>
                  </li>
               
                  <li class="nav-item me-3 me-lg-1" id="btn-next">
                    <a class="nav-link" href="#">
                      <span><i class="fas fa-circle-chevron-right fa-lg"></i></span>
                    </a>
                  </li>
                   
                  <li class="nav-item me-3 me-lg-1">
                    <a class="nav-link" href="#">
                      <span><i class="fas fa-trash-can fa-lg"></i></span>
                    </a>
                  </li>
                  <li class="nav-item me-3 me-lg-1">
                    <a class="nav-link" href="#" id="btn-prev">
                      <span><i class="fas fa-table-cells fa-lg"></i></span>
                    </a>
                  </li>                   
                  <li class="nav-item me-3 me-lg-1">
                    <a class="nav-link" href="#">
                      <span><i class="fas fa-circle-question fa-lg"></i></span>
                    </a>
                  </li>                  
                </ul>
                <!-- Right elements -->
              </div>
            </nav>
            <!-- Navbar -->

            <div class="jumbotron d-flex align-items-center justify-content-center text-center">
                  <canvas id="c" class="canvas rounded"></canvas></p>
            </div>
        
      </div>
           
    </div>


   <script type="text/javascript">

    var currentImage = 0
    var numberImages = 0
    var numberAnnotations = 0
    var numberAnnotationsLeft = 0
    var numberAutoAnnotations = 0

    var generateBtn = document.getElementById('btn-next');
    generateBtn.addEventListener('click', btnNext);

    fabric.Object.prototype.set({
        transparentCorners: false,
        borderColor: '#ffff00',
        cornerColor: '#ffff00'
    }); 

           var canvas = new fabric.Canvas('c');
           canvas.backgroundColor = '#333';
           canvas.setDimensions({width:640, height:480});


           // create a rectangle with angle=45
           var rect = new fabric.Rect({
               left: 20,
               top: 20,
               fill:'transparent',
               width: 100,
               height: 100,
               strokewidth: 1,
               stroke: '#f5ef42',
               strokeUniform: true
           });

           canvas.add(rect);
           canvas.item(0).lockRotation = true;
           rect.setControlsVisibility({ mtr: false })

           canvas.on('mouse:up', onMouseUp);

           // Assign object width and height to width and height variables
           // Change the vars if a scale even occurs
           // Need to so this because the scale values are null until a scale action occurs
           cwidth = rect.width;
           cheight = rect.height;
           ctop = rect.top;
           cleft = rect.left;

           function onMouseUp(e) {
               targetObject = e.target;
               console.log('Width =  '+ cwidth);
               console.log('Height =  '+ cheight);
               console.log('X = '+ cleft);     
               console.log('Y = '+ ctop);           
           }

           function onScale(e) {
               targetObject = e.target;
               cwidth = targetObject.getScaledWidth();
               cheight = targetObject.getScaledHeight();
               ctop = targetObject.get('top');
               cleft = targetObject.get('left');
           }

           canvas.on('mouse:up', onMouseUp);
           canvas.on('object:scaling', onScale);


           fabric.Object.prototype.objectCaching = false;

           // Function to handle the next button
           function btnNext() {
              // fetchId = currentid + 1;
              currentImage = currentid + 1;
              console.log("Next: " + currentImage)
              fetchData(currentImage);
           }

          function fetchData(annotationId) {
            //currentid = annotationId;

            fetch('http://127.0.0.1:5000/getimage?id=' + annotationId)
              .then(function (response) {
                if (response.status !== 200) {
                  console.log(
                    'Looks like there was a problem. Status Code: ' + response.status
                  );
                  return;
                }

                response.json().then(function (data) {

                  numberImages = data.imagecount;
                  currentImage = data.imagenumber + 1;
                  console.log("Current Image: " + currentImage + " / " + numberImages)
                  if (numberImages == 0 ){
                    document.getElementById('imagecounter').innerHTML = "No images available yet";
                    document.getElementById('btn-next').classList.add("disabled");
                    document.getElementById('btn-prev').classList.add("disabled");
                    return;
                  }

                  document.getElementById('imagecounter').innerHTML = (currentImage) + " / " + numberImages + " <br/><small>Last Annotated: " + data.lastupdated + "</small>";
                  // Update previous and next buttons - only enable if there are previous and next images available
                  //console.log("Image #: " + (currentImage) + " / " + numberImages)
                  if (currentImage == numberImages) {
                    document.getElementById('btn-next').classList.add("disabled");
                  }
                  else {
                    document.getElementById('btn-next').classList.remove("disabled");
                  }
                  if (currentImage == 0) {
                    document.getElementById('btn-prev').classList.add("disabled");
                  }
                  else {
                    document.getElementById('btn-prev').classList.remove("disabled");
                  }

                  newimage = "/static/dataset/" + data.image;
                  fabric.Image.fromURL(newimage, function (img) {    
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: 1,
                    scaleY: 1
                    });
                  });

                  rect.set({
                    left: data.bbox[0],
                    top: data.bbox[1],
                    width: data.bbox[2],
                    height: data.bbox[3],
                    visible:true,
                    scaleX: 1,
                    scaleY: 1
                  });

                  cwidth = data.bbox[0];
                  cheight = data.bbox[1];
                  ctop = data.bbox[2];
                  cleft = data.bbox[3];
                  
                  rect.setCoords();
                  
                  currentImage += 1;
                });
              })
              .catch(function (err) {
                console.log('Fetch Error :-S', err);
              });
          }

          function initialize() {
            fetch('http://127.0.0.1:5000/annotateinit')
              .then(function (response) {
                if (response.status !== 200) {
                  console.log(
                    'Looks like there was a problem. Status Code: ' + response.status
                  );
                  return;
                }
                response.json().then(function (data) {
                  numberImages = data.numberImages;
                  numberAnnotations = data.numberAnnotations;
                  numberAnnotationsLeft = data.numberAnnotationsLeft;
                  numberAutoAnnotations = data.numberAutoAnnotations;
                  numberManualAnnotations = data.numberManualAnnotations;
                  currentImage = 1;
                  if (numberImages > 0) {
                    fetchData(currentImage);
                  }
                })
              }
            )
          }

          //fetchData(0);
          initialize();

    </script>

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/popper.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/main.js"></script>
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.1/mdb.min.js"></script>    
  </body>
</html>